//@version=5
strategy("KiteAlerts Strategy (C/D/F/S)", overlay=true, initial_capital=1000000, default_qty_type=strategy.percent_of_equity, default_qty_value=100)

// ==============================================================================
// 1. INPUTS & CONFIGURATION
// ==============================================================================
selected_strat = input.string("Nifty (Mode C/D/F)", "Strategy Focus", options=["Nifty (Mode C/D/F)", "Sensex (Mode S)"])

len_ema20 = 20
len_ema50 = 50
len_atr   = 14
len_rsi   = 14

// Time Range for Backtest
startYear = input.int(2025, "Start Year")
startMonth = input.int(1, "Start Month")
startDay = input.int(1, "Start Day")
dateFilter = (time >= timestamp(syminfo.timezone, startYear, startMonth, startDay, 0, 0))

// Variables to store trade entry prices
var float entry_price = na
var float sl_price = na
var float tp_price = na

// ==============================================================================
// 2. INDICATORS (5-Minute)
// ==============================================================================
ema20 = ta.ema(close, len_ema20)
ema50 = ta.ema(close, len_ema50)
atr   = ta.atr(len_atr)
rsi   = ta.rsi(close, len_rsi)

// Slope (3-candle lookback)
slope = ema20 - ema20[3]

// ==============================================================================
// 3. MULTI-TIMEFRAME TREND (30-Minute)
// ==============================================================================
// We fetch 30m data to determine the "Global Trend"
tf_30m = "30"
[test_c30, ema20_30, ema50_30, atr_30] = request.security(syminfo.tickerid, tf_30m, [close, ta.ema(close, 20), ta.ema(close, 50), ta.atr(14)], lookahead=barmerge.lookahead_on)

// 30m Trend Logic
trend_bullish = (test_c30 > ema20_30) and (ema20_30 > ema50_30)
trend_bearish = (test_c30 < ema20_30) and (ema20_30 < ema50_30)

// State Machine for "New Trend" vs "Confirmed Trend"
var string trend_state = "NEUTRAL"
var int candles_since_trend_change = 0

new_trend = "NEUTRAL"
if trend_bullish
    new_trend := "BULLISH"
else if trend_bearish
    new_trend := "BEARISH"

if new_trend != trend_state
    trend_state := new_trend
    candles_since_trend_change := 0
else
    candles_since_trend_change += 1

is_confirmed = (candles_since_trend_change >= 6)

// ==============================================================================
// 4. STRATEGY MODES (C, D, F, S)
// ==============================================================================

// ----------------------------------------
// MODE C: MOMENTUM / BREAKOUT
// ----------------------------------------
mode_c_buy = false
mode_c_sell = false

inside_bar = high[1] < high[2] and low[1] > low[2]
if is_confirmed and trend_state == "BULLISH" and inside_bar and close > high[1] and rsi > 50
    mode_c_buy := true
if is_confirmed and trend_state == "BEARISH" and inside_bar and close < low[1] and rsi < 50
    mode_c_sell := true

// ----------------------------------------
// MODE D: OPENING DRIVE (First 15 mins)
// ----------------------------------------
mode_d_buy = false
mode_d_sell = false

// Time window: 09:15 - 09:30 IST
is_opening_window = (hour == 9 and minute >= 15 and minute <= 30)

if is_opening_window
    // Aggressive entry on strong momentum
    // Buy: Price > EMA20, Green candle, RSI > 45
    if close > ema20 and close > open and rsi > 45
        mode_d_buy := true
    // Sell: Price < EMA20, Red candle, RSI < 55
    if close < ema20 and close < open and rsi < 55
        mode_d_sell := true

// ----------------------------------------
// MODE F: 3-GEAR ENGINE
// ----------------------------------------
mode_f_buy = false
mode_f_sell = false
var string gear_label = ""

// Volatility Regime (ATR/Price percentage)
atr_pct = (atr / close) * 100
is_low_vol = atr_pct < 0.15
is_high_vol = atr_pct > 0.25

// GEAR 1: Trend Pullback (Low/Normal Vol)
if not is_high_vol
    if trend_state == "BULLISH" and low <= (ema20 * 1.0005) and close > ema20
        mode_f_buy := true
        gear_label := "G1"
    if trend_state == "BEARISH" and high >= (ema20 * 0.9995) and close < ema20
        mode_f_sell := true
        gear_label := "G1"

// GEAR 3: Momentum Impulse (High Vol)
if is_high_vol
    body_size = math.abs(close - open)
    is_impulse = body_size > (1.5 * atr)
    if is_impulse and close > open and trend_state == "BULLISH"
        mode_f_buy := true
        gear_label := "G3"
    if is_impulse and close < open and trend_state == "BEARISH"
        mode_f_sell := true
        gear_label := "G3"

// ----------------------------------------
// MODE S: SENSEX SPECIAL (Buckets)
// ----------------------------------------
mode_s_buy = false
mode_s_sell = false
var string bucket_label = ""

// VWAP Calculation
vwap_val = ta.vwap(close)

// Bucket A: Core (Trend) - Always Active
if close > ema20 and ema20 > ema50
    if low <= (ema20 * 1.001) and close > ema20 and close > open
        mode_s_buy := true
        bucket_label := "CORE"
if close < ema20 and ema20 < ema50
    if high >= (ema20 * 0.999) and close < ema20 and close < open
        mode_s_sell := true
        bucket_label := "CORE"

// Bucket B: Stability (VWAP Mean Reversion)
is_afternoon = (hour >= 13 and minute >= 30) or (hour >= 14)

if is_afternoon
    dist_vwap = (close - vwap_val) / vwap_val
    // Buy Oversold (< -0.3%)
    if dist_vwap < -0.003 and close > ema20 and close > open
        mode_s_buy := true
        bucket_label := "STAB"
    // Sell Overbought (> 0.3%)
    if dist_vwap > 0.003 and close < ema20 and close < open
        mode_s_sell := true
        bucket_label := "STAB"

// ==============================================================================
// 5. EXECUTION & VISUALIZATION
// ==============================================================================
is_nifty_active = selected_strat == "Nifty (Mode C/D/F)"
is_sensex_active = selected_strat == "Sensex (Mode S)"

buy_signal = false
sell_signal = false

if is_sensex_active
    if mode_s_buy
        buy_signal := true
    if mode_s_sell
        sell_signal := true

if is_nifty_active
    if mode_c_buy or mode_d_buy or mode_f_buy
        buy_signal := true
    if mode_c_sell or mode_d_sell or mode_f_sell
        sell_signal := true

// EXECUTION
if buy_signal and strategy.position_size == 0 and dateFilter
    strategy.entry("Long", strategy.long)
    entry_price := close
    sl_price := close - (atr * 1.0)
    tp_price := close + (atr * 2.0)
    strategy.exit("Exit", "Long", stop=sl_price, limit=tp_price)

if sell_signal and strategy.position_size == 0 and dateFilter
    strategy.entry("Short", strategy.short)
    entry_price := close
    sl_price := close + (atr * 1.0)
    tp_price := close - (atr * 2.0)
    strategy.exit("Exit", "Short", stop=sl_price, limit=tp_price)

// ==============================================================================
// 6. PLOTTING
// ==============================================================================
plot(ema20, "EMA 20", color=color.blue, linewidth=2)
plot(ema50, "EMA 50", color=color.orange, linewidth=2)
plot(vwap_val, "VWAP", color=color.purple, linewidth=1)

// Background color for Trend State
bgcolor(trend_state == "BULLISH" ? color.new(color.green, 90) : trend_state == "BEARISH" ? color.new(color.red, 90) : color.new(color.gray, 90))

// Plot signals with distinct shapes and colors
// MODE C
plotshape(mode_c_buy and is_nifty_active, style=shape.labelup, location=location.belowbar, color=color.teal, text="C", textcolor=color.white, size=size.small)
plotshape(mode_c_sell and is_nifty_active, style=shape.labeldown, location=location.abovebar, color=color.maroon, text="C", textcolor=color.white, size=size.small)

// MODE D
plotshape(mode_d_buy and is_nifty_active, style=shape.xcross, location=location.belowbar, color=color.yellow, text="D", textcolor=color.black, size=size.small)
plotshape(mode_d_sell and is_nifty_active, style=shape.xcross, location=location.abovebar, color=color.orange, text="D", textcolor=color.black, size=size.small)

// MODE F - GEAR 1
plotshape(mode_f_buy and gear_label == "G1" and is_nifty_active, style=shape.triangleup, location=location.belowbar, color=color.green, text="F-G1", textcolor=color.white, size=size.small)
plotshape(mode_f_sell and gear_label == "G1" and is_nifty_active, style=shape.triangledown, location=location.abovebar, color=color.red, text="F-G1", textcolor=color.white, size=size.small)

// MODE F - GEAR 3
plotshape(mode_f_buy and gear_label == "G3" and is_nifty_active, style=shape.triangleup, location=location.belowbar, color=color.lime, text="F-G3", textcolor=color.white, size=size.small)
plotshape(mode_f_sell and gear_label == "G3" and is_nifty_active, style=shape.triangledown, location=location.abovebar, color=color.fuchsia, text="F-G3", textcolor=color.white, size=size.small)

// MODE S - CORE
plotshape(mode_s_buy and bucket_label == "CORE" and is_sensex_active, style=shape.arrowup, location=location.belowbar, color=color.blue, text="S-CORE", textcolor=color.white, size=size.small)
plotshape(mode_s_sell and bucket_label == "CORE" and is_sensex_active, style=shape.arrowdown, location=location.abovebar, color=color.purple, text="S-CORE", textcolor=color.white, size=size.small)

// MODE S - STABILITY
plotshape(mode_s_buy and bucket_label == "STAB" and is_sensex_active, style=shape.arrowup, location=location.belowbar, color=color.aqua, text="S-STAB", textcolor=color.white, size=size.small)
plotshape(mode_s_sell and bucket_label == "STAB" and is_sensex_active, style=shape.arrowdown, location=location.abovebar, color=color.navy, text="S-STAB", textcolor=color.white, size=size.small)
